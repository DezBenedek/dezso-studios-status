<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusPulse Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        :root { --bg: #0b1120; --card: #1e293b; --accent: #3b82f6; --success: #10b981; --danger: #f43f5e; --empty: #334155; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f1f5f9; overflow-x: hidden; }
        .sidebar { background-color: #0f172a; border-right: 1px solid rgba(255,255,255,0.05); }
        .heartbeat-bar { display: flex; gap: 3px; height: 35px; align-items: flex-end; }
        .heartbeat-piece { flex: 1; border-radius: 3px; min-width: 8px; transition: all 0.2s; position: relative; }
        .heartbeat-piece:hover { transform: scaleY(1.2); filter: brightness(1.2); cursor: pointer; }
        .active-monitor { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); }
        
        /* Tooltip stílus */
        .heartbeat-piece[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 50;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">
    <aside class="sidebar w-full md:w-80 h-full flex flex-col hidden md:flex">
        <div class="p-6 border-b border-white/5 flex items-center gap-2 text-indigo-400 font-bold text-xl">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            StatusPulse
        </div>
        <div id="monitor-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </aside>

    <main id="detail-view" class="flex-1 overflow-y-auto p-4 md:p-10">
        <div class="flex items-center justify-center h-full text-slate-500 italic">Adatok betöltése...</div>
    </main>

    <script>
        let rawData = {};
        let activeId = null;

        async function refresh() {
            try {
                const res = await fetch('?api=true');
                rawData = await res.json();
                const ids = Object.keys(rawData);
                if (!activeId && ids.length > 0) activeId = ids[0];
                render();
            } catch (e) { console.error("API hiba", e); }
        }

        function calculateUptime(monitor) {
            const logs = monitor.detailedLogs || [];
            if (logs.length === 0) return "100.0";
            const up = logs.filter(l => l.ok).length;
            return ((up / logs.length) * 100).toFixed(1);
        }

        function render() {
            const list = document.getElementById('monitor-list');
            list.innerHTML = '';
            
            Object.keys(rawData).forEach(id => {
                const m = rawData[id];
                const isOnline = m.lastStatus?.ok;
                const div = document.createElement('div');
                div.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all ${activeId === id ? 'active-monitor' : 'hover:bg-white/5'}`;
                div.onclick = () => { activeId = id; render(); };
                div.innerHTML = `
                    <div class="h-2.5 w-2.5 rounded-full ${isOnline ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.5)]'}"></div>
                    <div class="flex-1 truncate text-sm font-semibold ${activeId === id ? 'text-white' : 'text-slate-400'}">${m.name}</div>
                `;
                list.appendChild(div);
            });

            const m = rawData[activeId];
            if (!m) return;

            // Fix 30 blokk generálása
            const totalBlocks = 30;
            const recentLogs = m.detailedLogs.slice(-totalBlocks);
            let heartbeatHtml = '';
            
            for (let i = 0; i < totalBlocks; i++) {
                const logIndex = i - (totalBlocks - recentLogs.length);
                if (logIndex >= 0) {
                    const log = recentLogs[logIndex];
                    const timeStr = new Date(log.time).toLocaleTimeString('hu-HU');
                    const statusText = log.ok ? 'Online' : `Hiba: ${log.status}`;
                    heartbeatHtml += `<div class="heartbeat-piece ${log.ok ? 'bg-emerald-500' : 'bg-rose-500'} h-full" title="${timeStr} - ${statusText} (${log.responseTime}ms)"></div>`;
                } else {
                    heartbeatHtml += `<div class="heartbeat-piece bg-slate-700 h-1/2" title="Nincs adat"></div>`;
                }
            }

            document.getElementById('detail-view').innerHTML = `
                <div class="max-w-4xl mx-auto space-y-8 animate-in fade-in">
                    <div class="bg-slate-800/40 border border-white/5 rounded-[2rem] p-8 flex justify-between items-center">
                        <div>
                            <h2 class="text-4xl font-black text-white mb-2">${m.name}</h2>
                            <p class="text-indigo-400 font-medium opacity-80">${m.url}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] uppercase font-bold text-slate-500 mb-1">Jelenlegi állapot</div>
                            <div class="text-3xl font-black ${m.lastStatus?.ok ? 'text-emerald-500' : 'text-rose-500'}">${m.lastStatus?.ok ? 'ONLINE' : 'OFFLINE'}</div>
                        </div>
                    </div>

                    <div class="bg-slate-800/40 border border-white/5 rounded-[1.5rem] p-6">
                        <div class="flex justify-between items-center mb-4 text-xs font-bold text-slate-400 uppercase tracking-widest">
                            <span>Utolsó 30 mérés</span>
                            <span>${calculateUptime(m)}% Uptime</span>
                        </div>
                        <div class="heartbeat-bar">${heartbeatHtml}</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-slate-800/40 border border-white/5 rounded-3xl p-6">
                            <div class="text-slate-500 text-[10px] font-bold uppercase mb-2">Válaszidő</div>
                            <div class="text-2xl font-bold text-white">${m.lastStatus?.responseTime || 0} ms</div>
                        </div>
                        <div class="bg-slate-800/40 border border-white/5 rounded-3xl p-6">
                            <div class="text-slate-500 text-[10px] font-bold uppercase mb-2">Havi Uptime</div>
                            <div class="text-2xl font-bold text-emerald-500">${calculateUptime(m)}%</div>
                        </div>
                        <div class="bg-slate-800/40 border border-white/5 rounded-3xl p-6">
                            <div class="text-slate-500 text-[10px] font-bold uppercase mb-2">Frissítve</div>
                            <div class="text-lg font-bold text-white">${m.lastStatus ? new Date(m.lastStatus.time).toLocaleTimeString('hu-HU') : '-'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        refresh();
        setInterval(refresh, 20000);
    </script>
</body>
</html>
