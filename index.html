<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusPulse | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0c10; color: #c9d1d9; }
        .monitor-card { background: #161b22; border: 1px solid #30363d; }
        .bar-segment { flex: 1; border-radius: 2px; height: 30px; }
        .active-link { background: #1f2937; border-left: 4px solid #2f81f7; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row">
    <aside class="w-full md:w-72 border-r border-[#30363d] bg-[#0d1117] flex flex-col">
        <div class="p-6 border-b border-[#30363d] flex justify-between items-center">
            <span class="font-bold text-white uppercase tracking-tighter">StatusPulse</span>
            <button onclick="toggleAdmin()" class="text-[#8b949e] hover:text-white">⚙️</button>
        </div>
        <div id="monitor-list" class="flex-1 overflow-y-auto p-3 space-y-1"></div>
    </aside>

    <main class="flex-1 p-6 md:p-12 overflow-y-auto relative">
        <div id="admin-panel" class="hidden absolute top-6 right-6 z-50 bg-[#161b22] border border-[#30363d] p-6 rounded-xl shadow-2xl w-96">
            <h4 class="text-sm font-bold mb-4">Beállítások</h4>
            <input type="password" id="admin-pw" placeholder="Admin jelszó" class="w-full bg-[#0d1117] border border-[#30363d] p-2 rounded mb-4 outline-none text-sm">
            <div id="sites-config" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <button onclick="addSiteRow()" class="w-full border border-dashed border-[#30363d] text-xs py-2 mb-4 hover:bg-white/5">+ Új oldal</button>
            <button onclick="saveSites()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded mb-2">Mentés és Frissítés</button>
            <button onclick="manualCheck()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 rounded">Azonnali Ellenőrzés</button>
        </div>

        <div id="detail-view" class="max-w-5xl mx-auto"></div>
    </main>

    <script>
        let rawData = {};
        let siteList = [];
        let activeId = null;

        function toggleAdmin() { document.getElementById('admin-panel').classList.toggle('hidden'); }

        function addSiteRow(name = '', url = '') {
            const container = document.getElementById('sites-config');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <input type="text" placeholder="Név" value="${name}" class="site-name w-1/3 bg-[#0d1117] border border-[#30363d] p-1 rounded text-xs">
                <input type="text" placeholder="URL" value="${url}" class="site-url w-1/2 bg-[#0d1117] border border-[#30363d] p-1 rounded text-xs">
                <button onclick="this.parentElement.remove()" class="text-red-500">×</button>
            `;
            container.appendChild(div);
        }

        async function saveSites() {
            const password = document.getElementById('admin-pw').value;
            const names = [...document.querySelectorAll('.site-name')].map(i => i.value);
            const urls = [...document.querySelectorAll('.site-url')].map(i => i.value);
            const sites = names.map((name, i) => ({ id: name.toLowerCase().replace(/\s+/g, '-'), name, url: urls[i] }));

            const res = await fetch('/update-sites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password, sites })
            });
            if(res.ok) { alert("Sikeres mentés!"); refresh(); } else { alert("Hiba!"); }
        }

        async function manualCheck() {
            const password = document.getElementById('admin-pw').value;
            const res = await fetch('/run-check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if(res.ok) { refresh(); } else { alert("Hiba!"); }
        }

        async function refresh() {
            const res = await fetch('?api=true');
            const json = await res.json();
            rawData = json.data;
            siteList = json.sites;
            if (!activeId && siteList.length > 0) activeId = siteList[0].id;
            
            const configContainer = document.getElementById('sites-config');
            configContainer.innerHTML = '';
            siteList.forEach(s => addSiteRow(s.name, s.url));
            
            render();
        }

        function render() {
            const list = document.getElementById('monitor-list');
            list.innerHTML = siteList.map(s => `
                <div onclick="activeId='${s.id}';render()" class="p-3 rounded-lg cursor-pointer flex items-center gap-3 ${activeId===s.id ? 'active-link' : ''}">
                    <div class="w-2 h-2 rounded-full ${rawData[s.id]?.lastStatus?.ok ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="text-sm font-medium">${s.name}</span>
                </div>
            `).join('');

            const m = rawData[activeId];
            if (!m) return;
            const upCount = m.detailedLogs.filter(l => l.ok).length;
            const uptime = ((upCount / (m.detailedLogs.length || 1)) * 100).toFixed(2);
            
            document.getElementById('detail-view').innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-white">${m.name}<span class="block text-sm font-normal text-blue-400">${m.url}</span></h1>
                    <div class="px-4 py-2 rounded-full font-bold ${m.lastStatus?.ok ? 'text-green-500' : 'text-red-500'} bg-white/5">${m.lastStatus?.ok ? 'ONLINE' : 'OFFLINE'}</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500">Uptime</div><div class="text-2xl font-bold">${uptime}%</div></div>
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500">Válaszidő</div><div class="text-2xl font-bold">${m.lastStatus?.responseTime}ms</div></div>
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500">Utolsó válasz</div><div class="text-2xl font-bold">${m.lastStatus?.status}</div></div>
                </div>
                <div class="monitor-card p-6 rounded-xl">
                    <div class="status-bar flex gap-1 items-end h-10">
                        ${Array.from({length: 30}, (_, i) => {
                            const log = m.detailedLogs.slice(-30)[i - (30 - Math.min(m.detailedLogs.length, 30))];
                            return log ? `<div class="bar-segment ${log.ok ? 'bg-green-600' : 'bg-red-600'}" title="${log.responseTime}ms"></div>` : `<div class="bar-segment bg-[#21262d]"></div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        refresh();
        setInterval(refresh, 30000);
    </script>
</body>
</html>
