<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatusPulse | Dezső Studios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root { --bg: #0a0c10; --card: #161b22; --border: #30363d; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #c9d1d9; }
        .monitor-card { background: var(--card); border: 1px solid var(--border); }
        .status-bar { display: flex; gap: 4px; height: 35px; }
        .bar-segment { flex: 1; border-radius: 3px; position: relative; }
        .active-link { background: #1f2937; border-left: 4px solid #2f81f7; }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row">
    <aside class="w-full md:w-72 border-r border-[#30363d] bg-[#0d1117] flex flex-col">
        <div class="p-6 border-b border-[#30363d] flex items-center justify-between">
            <span class="font-bold text-white uppercase tracking-tighter">StatusPulse</span>
            <button onclick="showAdmin()" class="text-[#8b949e] hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
        <div id="monitor-list" class="flex-1 overflow-y-auto p-3 space-y-1"></div>
    </aside>

    <main class="flex-1 p-6 md:p-12 overflow-y-auto relative">
        <div id="admin-panel" class="hidden absolute top-6 right-6 z-50 bg-[#161b22] border border-[#30363d] p-4 rounded-xl shadow-2xl w-64">
            <h4 class="text-sm font-bold mb-3">Admin Műveletek</h4>
            <input type="password" id="admin-pw" placeholder="Jelszó" class="w-full bg-[#0d1117] border border-[#30363d] p-2 rounded text-sm mb-2 outline-none">
            <button id="btn-run" onclick="manualCheck()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded transition-colors">Ellenőrzés Indítása</button>
            <button onclick="showAdmin()" class="w-full text-[#8b949e] text-[10px] mt-2">Bezárás</button>
        </div>

        <div id="detail-view" class="max-w-5xl mx-auto italic text-slate-500">Adatok szinkronizálása...</div>
    </main>

    <script>
        let rawData = {};
        let activeId = null;

        function showAdmin() { document.getElementById('admin-panel').classList.toggle('hidden'); }

        async function manualCheck() {
            const password = document.getElementById('admin-pw').value;
            const btn = document.getElementById('btn-run');
            btn.innerText = "Futás...";
            btn.disabled = true;

            try {
                const res = await fetch('/run-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (res.ok) {
                    alert("Sikeres manuális frissítés!");
                    refresh();
                } else {
                    alert("Hiba: " + await res.text());
                }
            } catch (e) { alert("Hiba történt!"); }
            btn.innerText = "Ellenőrzés Indítása";
            btn.disabled = false;
        }

        async function refresh() {
            try {
                const res = await fetch('?api=true');
                rawData = await res.json();
                if (!activeId) activeId = Object.keys(rawData)[0];
                render();
            } catch (e) { console.error(e); }
        }

        function calculateUptime(m) {
            const logs = m.detailedLogs || [];
            if (!logs.length) return "100.0";
            return ((logs.filter(l => l.ok).length / logs.length) * 100).toFixed(2);
        }

        function render() {
            const list = document.getElementById('monitor-list');
            list.innerHTML = Object.keys(rawData).map(id => `
                <div onclick="activeId='${id}';render()" class="p-3 rounded-lg cursor-pointer flex items-center gap-3 transition-colors ${activeId===id ? 'active-link text-white' : 'text-[#8b949e]'}">
                    <div class="w-2 h-2 rounded-full ${rawData[id].lastStatus?.ok ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="text-sm font-medium">${rawData[id].name}</span>
                </div>
            `).join('');

            const m = rawData[activeId];
            if (!m) return;
            
            const uptime = calculateUptime(m);
            const displayLogs = m.detailedLogs.slice(-30);
            let barHtml = Array.from({length: 30}, (_, i) => {
                const log = displayLogs[i - (30 - displayLogs.length)];
                return log ? `<div class="bar-segment ${log.ok ? 'bg-[#238636]' : 'bg-[#da3633]'} h-full" title="${new Date(log.time).toLocaleTimeString()} | ${log.responseTime}ms"></div>` 
                           : `<div class="bar-segment bg-[#21262d] h-1/2"></div>`;
            }).join('');

            document.getElementById('detail-view').innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-white">${m.name} <span class="text-sm font-normal text-blue-400 block">${m.url}</span></h1>
                    <div class="px-4 py-2 rounded-full bg-white/5 font-bold ${m.lastStatus?.ok ? 'text-green-500' : 'text-red-500'} uppercase">${m.lastStatus?.ok ? 'Online' : 'Hiba'}</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500 mb-1">Uptime</div><div class="text-2xl font-bold">${uptime}%</div></div>
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500 mb-1">Válaszidő</div><div class="text-2xl font-bold">${m.lastStatus?.responseTime}ms</div></div>
                    <div class="monitor-card p-5 rounded-xl"><div class="text-xs text-slate-500 mb-1">Státusz</div><div class="text-2xl font-bold">${m.lastStatus?.status}</div></div>
                </div>
                <div class="monitor-card p-6 rounded-xl">
                    <div class="flex justify-between mb-4 text-xs font-bold text-slate-500 uppercase italic"><span>Utolsó 30 mérés</span><span>${uptime}%</span></div>
                    <div class="status-bar">${barHtml}</div>
                </div>
            `;
        }

        refresh();
        setInterval(refresh, 30000);
    </script>
</body>
</html>
